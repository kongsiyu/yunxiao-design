# 评审状态机 - 基于评论

## 状态流转图

```
[设计中]
    │
    ▼ (AI 生成 PRD)
[AI 设计完成]
    │
    ▼ (AI 发起评审)
[需求评审中] ◄──────┐
    │              │
    ├─ 提问 ───────┤ (AI 回答)
    │              │
    ├─ 要求 ───────┤ (AI 修改)
    │              │
    ▼ 评审通过      ▼ 评审不通过
[需求评审通过]   [需求评审不通过]
    │              │
    └──────────────┘
           │
           ▼ (重新发起评审)
    [需求评审中]
```

## 状态标记

每条评论都会包含【当前状态】标记：

| 阶段 | 状态标记 | 说明 |
|------|---------|------|
| 设计完成 | `【当前状态】设计已完成` | PRD 已生成，准备评审 |
| 评审中 | `【当前状态】需求评审中` | 等待评审人回复 |
| 评审中 (修改) | `【当前状态】需求评审中（修改中）` | AI 正在按要求修改 |
| 评审通过 | `【当前状态】需求评审通过` | 评审结束，设计确认 |
| 评审不通过 | `【当前状态】需求评审不通过` | 评审结束，需要修改 |

## 评论类型处理

| 类型 | 关键词 | AI 响应 | 状态变化 |
|------|-------|--------|---------|
| 提问 | 为什么/怎么/如何/什么/吗 | 回答问题 | 保持评审中 |
| 要求 | 修改/调整/增加/删除 | 记录要求并修改 | 保持评审中（修改中） |
| 通过 | 评审通过/可以/没问题 | 结束评审 | → 评审通过 |
| 不通过 | 评审不通过/不行/有问题 | 结束评审 | → 评审不通过 |

## 为什么不修改工作项状态？

云效 API 限制：
- 状态转换 API 返回 404
- 直接更新 status 字段返回 400（状态不存在）
- 每个项目的状态工作流是自定义的，无法通用

解决方案：
- 使用评论标记状态流转
- 每条评论包含【状态流转】和【当前状态】
- 通过评论历史可以追溯完整状态变化

## 文件说明

| 文件 | 作用 |
|------|------|
| check-requirements.py | 检查需求 → 生成 PRD → 发起评审 |
| check-reviews.py | 检查评论 → 分类处理 → 更新状态 |
| STATE_MACHINE.md | 状态机说明（本文件） |
